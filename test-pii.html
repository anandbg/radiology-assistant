<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PII Detection Test</title>
</head>
<body>
    <h1>PII Detection Test</h1>
    <textarea id="testText" style="width: 100%; height: 200px;">
hey this is actually a test to see if the local transcription is actually working for patient rocket and his date of birth is 24th of seven 1975
    </textarea>
    <br>
    <button onclick="testPII()">Test PII Detection</button>
    <div id="results"></div>

    <script>
    function detectPIILocally(text) {
        const piiPatterns = {
            nhsNumber: /\b(?:\d{3}\s*\d{3}\s*\d{4}|\d{10})\b/g,
            postcode: /\b[A-Z]{1,2}[0-9][A-Z0-9]?\s*[0-9][A-Z]{2}\b/gi,
            niNumber: /\b[A-Z]{2}\s*\d{2}\s*\d{2}\s*\d{2}\s*[A-Z]\b/gi,
            email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
            phone: /\b(?:\+44|0)(?:\d{2}\s*\d{4}\s*\d{4}|\d{3}\s*\d{3}\s*\d{4}|\d{4}\s*\d{6})\b/g,
            // Date patterns - various formats including spoken dates
            dateOfBirth: /\b(?:\d{1,2}(?:st|nd|rd|th)?\s+(?:of\s+)?(?:january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)\s+\d{4}|\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2})\b/gi,
            // Patient names - common patterns
            patientName: /\b(?:patient|mr|mrs|ms|miss|dr)\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?\b/gi
        };

        let detected = false;
        const detectedTypes = [];
        let cleanText = text;

        for (const [type, pattern] of Object.entries(piiPatterns)) {
            if (pattern.test(text)) {
                detected = true;
                detectedTypes.push(type);
                // Custom replacements for different PII types
                switch (type) {
                    case 'nhsNumber':
                        cleanText = cleanText.replace(pattern, '[NHS-NUMBER]');
                        break;
                    case 'postcode':
                        cleanText = cleanText.replace(pattern, '[POSTCODE]');
                        break;
                    case 'niNumber':
                        cleanText = cleanText.replace(pattern, '[NI-NUMBER]');
                        break;
                    case 'email':
                        cleanText = cleanText.replace(pattern, '[EMAIL]');
                        break;
                    case 'phone':
                        cleanText = cleanText.replace(pattern, '[PHONE]');
                        break;
                    case 'dateOfBirth':
                        cleanText = cleanText.replace(pattern, '[DATE-OF-BIRTH]');
                        break;
                    case 'patientName':
                        cleanText = cleanText.replace(pattern, '[PATIENT-NAME]');
                        break;
                    default:
                        cleanText = cleanText.replace(pattern, `[${type.toUpperCase()}]`);
                }
            }
        }

        return {
            detected,
            types: detectedTypes,
            originalText: text,
            cleanedText: cleanText
        };
    }

    function markPIIInText(text, piiResult) {
        if (!piiResult.detected) return text;
        
        let markedText = text;
        
        const piiPatterns = {
            nhsNumber: /\b(?:\d{3}\s*\d{3}\s*\d{4}|\d{10})\b/g,
            postcode: /\b[A-Z]{1,2}[0-9][A-Z0-9]?\s*[0-9][A-Z]{2}\b/gi,
            niNumber: /\b[A-Z]{2}\s*\d{2}\s*\d{2}\s*\d{2}\s*[A-Z]\b/gi,
            email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
            phone: /\b(?:\+44|0)(?:\d{2}\s*\d{4}\s*\d{4}|\d{3}\s*\d{3}\s*\d{4}|\d{4}\s*\d{6})\b/g,
            dateOfBirth: /\b(?:\d{1,2}(?:st|nd|rd|th)?\s+(?:of\s+)?(?:january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)\s+\d{4}|\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2})\b/gi,
            patientName: /\b(?:patient|mr|mrs|ms|miss|dr)\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?\b/gi
        };

        // Highlight each detected PII type
        for (const [type, pattern] of Object.entries(piiPatterns)) {
            if (piiResult.types.includes(type)) {
                markedText = markedText.replace(pattern, '<strong style="background-color: yellow; padding: 2px; border-radius: 3px;">$&</strong>');
            }
        }
        
        return markedText;
    }

    function testPII() {
        const text = document.getElementById('testText').value;
        const piiResult = detectPIILocally(text);
        
        const markedText = markPIIInText(text, piiResult);
        
        document.getElementById('results').innerHTML = `
            <h2>Results:</h2>
            <p><strong>Detected PII:</strong> ${piiResult.detected ? 'Yes' : 'No'}</p>
            <p><strong>Types:</strong> ${piiResult.types.join(', ')}</p>
            <p><strong>Original Text:</strong><br>${text}</p>
            <p><strong>Marked Text:</strong><br>${markedText}</p>
            <p><strong>Cleaned Text:</strong><br>${piiResult.cleanedText}</p>
        `;
    }
    </script>
</body>
</html>